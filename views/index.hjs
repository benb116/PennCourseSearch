<!doctype html>
<html>
	<head>
		<title>PennCourseScheduler</title>
		<meta charset="UTF-8">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <style type="text/css">
			body {width: 100%; text-align: center; margin: 0;}

			#LoadingInfo {margin-left: 1em;}

			#BottomResults {
			    width: 100%; height: 300px;
			    position: absolute;
			    background-color: #E6E6E6;
			    bottom: 0;
			}
			#CourseList, #SectionList {
				width: 200px; height: 300px;
				background-color: white;
				float: left;
				border-right: 3px solid #3399FF;
				overflow: scroll;
				list-style-type: none;}
			#InfoPanel {overflow: scroll; height: 300px;}
			ul {list-style-type: none; padding: 0;}
			li {cursor: pointer;}
			li:hover {background-color: #3399FF;}

			input[type="text"] { 
			    width: 40em;
			    border-radius:2px; 
			    border: solid 1px #ccc; 
			    padding:0.4em; 
			    background-color: #f5f5f5; 
			}
        </style>
	</head>
    <body>
        <h1>{{ title }}</h1>
        <form onkeypress="return event.keyCode != 13;">
			Search for courses: <input id="CSearch" type="text" name="courseSearch" autocomplete="off"><span id="LoadingInfo" style="opacity:0;">Loading...</span>
		</form>
        <div id="BottomResults">
        	<div id="CourseList"></div>
        	<div id="SectionList"></div>
        	<div id="InfoPanel"></div>
        </div>
    </body>
    <script type="text/javascript">
   	var delay = (function(){
	  var timer = 0;
	  return function(callback, ms){
	    clearTimeout (timer);
	    timer = setTimeout(callback, ms);
	  };
	})();

   	$('#CSearch').on('keyup', function(e){
		$('#LoadingInfo').css('opacity', '1');
		delay(function(){
		  	var searchTerms = $('#CSearch').val();

			try {
				if (searchTerms != "" && searchTerms != 'favicon.ico') {
					searchTerms = searchTerms.replace(' ', "/").replace(' ', "/").replace('-', "/").replace('-', "/");
					if (searchTerms.slice(-1) != '/') {
						searchTerms = searchTerms+'/';
					};

					var deptSearch = searchTerms.split("/")[0];
					var numbSearch = searchTerms.split("/")[1];
					var sectSearch = searchTerms.split("/")[2];
					if ((searchTerms.split("/").length - 1) >= 1) {
						getCourseNumbers(deptSearch);
					};
					if ((searchTerms.split("/").length - 1) >= 2) {
						getSectionNumbers(deptSearch+'/'+numbSearch);
					};
					if ((searchTerms.split("/").length - 1) == 3) {
						getSectionInfo(deptSearch+'/'+numbSearch+'/'+sectSearch);
					};
					
				} else {
					$('#CourseList').empty();
					$('#SectionList').empty();
					$('#InfoPanel').empty();
					console.log('test')
				}
			} 
			catch(err) {console.log('No Results');}

		}, 400);
	});
	function getCourseNumbers(dept) {
		$.get("/Search/"+dept)
		.done(function(data) {
			$('#CourseList').html(data);
			$('#LoadingInfo').css('opacity', '0');
			$('#CourseList li').click(function() {
				$('#CSearch').val($(this).html());
				var courseName = $(this).html().replace(' ', "/");
				$('#InfoPanel').html('');
				getSectionNumbers(courseName);
			});
		});
	}
	function getSectionNumbers(cnum) {
		$.get("/Search/"+cnum)
		.done(function(data) {
			$('#SectionList').html(data);
			$('#LoadingInfo').css('opacity', '0');
			$('#SectionList li').click(function() {
				$('#CSearch').val($(this).html());
				var secname = $(this).html().replace(' ', "/").replace(' ', "/");
				getSectionInfo(secname);
			});
		});
	}
	function getSectionInfo(sec) {
		$.get("/Search/"+sec)
		.done(function(data) {
			$('#InfoPanel').html(data);
			$('#LoadingInfo').css('opacity', '0');
			$('#InfoPanel li').click(function() {
				var secname = $(this).html().replace(' ', "/").replace(' ', "/");
				getSectionInfo(secname);
			});
		});
	}
    </script>
</html>